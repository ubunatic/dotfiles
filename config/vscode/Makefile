.PHONY: âš™ï¸  # make all non-file targets phony

SHELL  = bash
OS     = $(shell uname -s)
PREFIX = ${HOME}/.config

ifeq ($(OS),Darwin)
PREFIX = ${HOME}/Library/Application Support
endif

CODES = VSCodium code-oss code code-insiders Code
MERGETOOL = bash -ic "dotapps build" && govsbind

CODE   := $(shell for c in $(CODES); do test -d "$(PREFIX)/$$c" && echo "$$c" && break; done)
PREFIX := $(PREFIX)/$(CODE)/User

get_bindings = sed -e 's|//.*||g' "$(PREFIX)/keybindings.json" | jq -c '.[]' | sort -u

info: âš™ï¸  ## Show current settings
	@if test -e "$(PREFIX)/keybindings.json"; \
	 then echo "âœ… keybindings.json exists in $(PREFIX)"; $(MAKE) bindings; \
	 else echo "âŒ keybindings.json does not exist"; \
	 fi

bindings: âš™ï¸  ## Show current bindings
	@echo "â„¹ï¸ Bindings:"
	@$(get_bindings) | head -n 5
	@echo "..."
	@$(get_bindings) | tail -n 5
	@echo -nu "Total:"; $(get_bindings) | wc -l

diff: âš™ï¸  ## Show current diff
	@diff -u keybindings.json "$(PREFIX)/keybindings.json" || true

merge: âš™ï¸  ## Merge  bindings
	@$(MERGETOOL) keybindings.json "$(PREFIX)/keybindings.json"

import: âš™ï¸  ## Merge existing bindings to dotfiles bindings
	@$(MERGETOOL) keybindings.json "$(PREFIX)/keybindings.json" keybindings.json

clean-backups: âš™ï¸  ## Clean up backups
	@rm -f keybindings.json.bak.*

test-merge-tool:
	@$(MERGETOOL) keybindings.json "$(PREFIX)/keybindings.json"
	@echo "âœ… test-merge succeeded"

install: âš™ï¸  ## Install  bindings
	@mkdir -p "$(PREFIX)"
	@cp "$(PREFIX)/keybindings.json" "$(PREFIX)/keybindings.json.bak-dotfiles" 2> /dev/null && \
		echo "ğŸ’¾ backed up keybindings.json to $(PREFIX)/keybindings.json.bak-dotfiles" || \
		echo "no existing keybindings.json to backup"
	@cp keybindings.json "$(PREFIX)/keybindings.json"
	@echo "âœ… copied keybindings to $(PREFIX)"

uninstall: âš™ï¸  ## Uninstall bindings
	@rm -f "$(PREFIX)/keybindings.json"
	@mv "$(PREFIX)/keybindings.json.bak-dotfiles" "$(PREFIX)/keybindings.json" 2> /dev/null || true
	@echo "âœ… restored pre-install keybindings in $(PREFIX)"

help: âš™ï¸ usage  ## show this help

include ../../scripts/usage.mk