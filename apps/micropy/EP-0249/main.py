from machine import Pin, I2C, ADC
from ssd1306 import SSD1306_I2C
import framebuf
import time
import ina3221
from math import floor

WIDTH = 128
HEIGHT = 32

# logo 
buffer = bytearray(b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\xe3\xf8?\xc3\xc0\x1f\xe0?\xc0\x03\xfc\x03\xc1\xfc\x00?\xc3\xfc?\xf1\xc0\x1f\xf8\x7f\x80\x03\xff\x0f\x81\xfe\x00\x18C\x1e9\xf0\x00\x1cx\xf0\xc0\x03\x9f\x1f\xc0\x0f\x008\x00\x0exx\x00\x1c<\xe0\x00\x03\x87\x9d\x80\x0f\x008\x00\x0e8s\x80\x1c8\xf0\x00\x03\x87\x03\xc0\x06\x00:\x00\x1e8y\xc0\x1c8x\x00\x03\x87\x81\x80\x0e\x00?\xc0\x1c8s\x80\x1dx~\x00\x03\x87\x03\xc0\xfc\x00?\xc0<?\xf1\xc0\x1f\xe0?\x80\x03\xff\x03\x80\xfc\x00\x01\xe0\xf8?\xc3\x80\x1f\xe0\x0f\x87\xc3\xfc\x01\xc0>\x00\x00\xe1\xe0\x7f\x01\xc0\x1c\xf0\x03\xcf\xc7\xf0\x03\x80\x07\x00\x00\xe3\xc08\x03\x80\x1cp\x01\xc0C\x80\x01\xc0\x07\x00\x00\xe7\x808\x03\xc0\x1cx\x81\xc0\x03\x80\x03\x80\x07\x00!\xe7\xba8\x01\x80\x1c<\xd7\xc0\x03\x80\x01\xc1\x1f\x00?\xc7\xfe8\x03\xc0\x1c\x1c\xff\x80\x03\x80\x03\x83\xfe\x00?\x87\xfex\x01\x80\x1c\x1e\x7f\x00\x07\x80\x03\xc1\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00')
fb = framebuf.FrameBuffer(buffer, 128, 32, framebuf.MONO_HLSB)

i2c = I2C(0, scl=Pin(5), sda=Pin(4),freq=200000)
 
print(i2c.scan())

oled = SSD1306_I2C(WIDTH, HEIGHT, i2c, addr=0x3C)

INA3221_ADDR1 = hex(i2c.scan()[1])
INA3221_ADDR2 = hex(i2c.scan()[2])
print(INA3221_ADDR1)
print(INA3221_ADDR2)

# create instance of ina3221 chip.  0x41 and 0x40 are the register address of the chip. 
ina1 = ina3221.INA3221(i2c, 0x41)
ina2 = ina3221.INA3221(i2c, 0x40)
# clear screen
oled.fill(0)

oled.invert(0)
oled.fill(0)
oled.blit(fb, 0, 0)
oled.show()
time.sleep(5)
oled.fill(0)
# Put text on screen
#oled.text("Hello World", 0, 0)
while True:
    
    vbus1 = ina2.getVBus(0) / 1000.0  # 5v 
    vbus2 = ina2.getVBus(1) / 1000.0  # 5v
    vbus3 = ina2.getVBus(2) / 1000.0  # total 32v
    vbus4 = ina1.getVBus(1) / 1000.0 # 12v 
    
    ch1_current = ina2.getI(chl_num=0)
    ch2_current = ina2.getI(chl_num=1)
    ch3_current = ina2.getI(chl_num=2)
    ch4_current = ina1.getI(chl_num=1)
    
    
    oled.text(f"CH1:{vbus1:.1f}V", 0, 0)
    oled.text(f" {ch1_current /1000000.0:.1f}A", 64,0)
    
    oled.text(f"CH2:{vbus2:.1f}V", 0, 8)
    oled.text(f" {ch2_current /1000000.0:.1f}A", 64,8)
    
    oled.text(f"CH3:{vbus3:.1f}V", 0, 16)
    oled.text(f" {ch3_current/1000000.0:.1f}A", 64,16)
    
    oled.text(f"CH4:{vbus4:.1f}V", 0, 24)
    oled.text(f" {ch4_current/1000000.0:.1f}A", 64,24)
    oled.show()
    time.sleep(3)
    oled.fill(0)
    I_shunt0 = ina2.getIShunt(0)
    I_shunt1 = ina2.getIShunt(1)
    I_shunt2 = ina2.getIShunt(2)
    I_shunt3 = ina1.getIShunt(0)
    I_shunt4 = ina1.getIShunt(1)
    I_shunt5 = ina1.getIShunt(2)
    oled.text(f"V0:{(I_shunt0 / 1000000.0):.2f}A",0, 0)
    print(I_shunt0) 
    oled.text(f"I1:{(I_shunt1 / 1000000.0):.2f}A",68, 0)
    oled.text(f"I2:{(I_shunt2 / 1000000.0):.2f}A",0, 8)
    oled.text(f"I3:{(I_shunt3 / 1000000.0):.2f}A",68, 8)
    oled.text(f"I4:{(I_shunt4 / 1000000.0):.2f}A",0, 16)
    oled.text(f"I5:{(I_shunt5 / 1000000.0):.2f}A",68, 16)
    oled.show()
    time.sleep(3)
    oled.fill(0)

